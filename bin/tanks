#!/usr/bin/env python3

import logging as log
import pygame, math, ecs
from pygame.locals import *

from pytanks.systems import *
from pytanks.util import make_color_surface, RefFloat
from pytanks import make
from pytanks.scripts import EntityView

def main (fps, w, h):

    pygame.init ()
    log.basicConfig (format = "%(levelname)s %(name)s\n\t%(message)s\n", 
            level = log.INFO)

    surface = pygame.display.set_mode ( (w, h) )
    clock   = pygame.time.Clock ()

    time = RefFloat (0)
    entity_manager = EntityView (time)
    system_manager = ecs.managers.SystemManager (entity_manager)

    system_manager.add_system (MovementSystem (w, h))
    system_manager.add_system (RenderSystem (surface))
    system_manager.add_system (HealthSystem ())
    system_manager.add_system (HealthRenderSystem (surface))
    system_manager.add_system (WeaponSystem ())
    system_manager.add_system (MountSystem ())
    system_manager.add_system (CollisionSystem ())
    system_manager.add_system (ScriptSystem ())

    make.example_barrier (entity_manager, 100, (w / 4, 20), (w / 2, 100))
    for i in range (3):
        make.example_barrier (entity_manager, 20, (20, 20), (50 + i * (w - 100)/2, 50))

    make.example_turret (entity_manager, (w * .9, h * .9))
    make.example_turret (entity_manager, (w * .1, h * .9))

    dummy_bullet_props = (2, 60, 4, make_color_surface ( (5, 5), (255, 255, 0) ), (5, 5))

    make.example_scripted_tank (entity_manager, (w * .5, h * .5))

    frames = 0
    dt = 1/fps

    while 1:

        for e in pygame.event.get ():
            if e.type == QUIT: return

        system_manager.update (dt)
        pygame.display.update ()
        clock.tick (fps)
        frames += 1
        time += dt

if __name__ == "__main__":
    main (30, 640, 340)
